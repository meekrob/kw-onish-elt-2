---
title: "KW_ELT2_Figure5"
author: "Robert Williams"
date: "3/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

set if plots should be saved
```{r}
do_plot <- FALSE
```


```{r}
# BiocManager::install("biomaRt")
# install.packages("reticulate")
# install.packages("tidyverse")
# BiocManager::install("Biostrings")
# BiocManager::install("BSgenome.Celegans.UCSC.ce11")
# BiocManager::install("GenomicRanges")
# BiocManager::install("clusterProfiler")
# BiocManager::install("org.Ce.eg.db")
```


```{r}
library(biomaRt)
library(tidyverse)
library(reticulate)
library(lubridate)
use_condaenv("kw_fig5", required = TRUE)
# library(clusterProfiler)
# library("org.Ce.eg.db")

```
# Import dataframe to be analyzed

```{r}
fig4df <- read_csv(file = "../Figure_4_L1_Regulation/02_output/Figure4_WBGeneID_Annotation_Dataframe.csv")
```


# Use Tissue Enrichment Analysis to identify tissue of origin

Citation: Angeles-Albores, David, Raymond Y. N. Lee, Juancarlos Chan, and Paul W. Sternberg. “Tissue Enrichment Analysis for C. Elegans Genomics.” BMC Bioinformatics 17, no. 1 (September 13, 2016): 366. https://doi.org/10.1186/s12859-016-1229-9.

```{r}
tea <- import("tissue_enrichment_analysis")
tissue_df <- tea$fetch_dictionary("tissue")
phenotype_df <- tea$fetch_dictionary("phenotype")
go_df <- tea$fetch_dictionary("go")
```

# Tissue Enrichment Analysis function

```{r}

bound_classes <- paste("Class", LETTERS[1:4], sep = "")
my_tea_analysis <- function(input_df, tea_dict){
  tea_df <- data.frame()
  for (i in bound_classes){
  tea_set <- tea$enrichment_analysis(
    (input_df %>% 
       filter(bound_class == i))$WBGeneID, 
    tissue_df = tea_dict %>% 
      filter(wbid %in% (input_df %>% 
                          filter(bound_class %in% bound_classes))$WBGeneID)
  )
  if(nrow(tea_set) == 0){
    next
  } else {
  tea_df <- bind_rows(tea_df, data.frame(tea_set, class = i))
  }
}
tea_df
}
```

# Plotting helper functions

```{r}

reorder_within <- function(x, by, within, fun = mean, sep = "___", ...) {
    new_x <- paste(x, within, sep = sep)
    stats::reorder(new_x, by, FUN = fun)
}

scale_x_reordered <- function(..., sep = "___") {
    reg <- paste0(sep, ".+$")
    ggplot2::scale_x_discrete(labels = function(x) gsub(reg, "", x), ...)
}

my_ontology_plot <- function(input_df, xlabel){
  input_df %>%
  filter(Q.value < 0.05,  Observed > 5) %>% 
  ggplot(aes(x = reorder_within(Term, -log10(Q.value), class), y = -log10(Q.value))) +
  geom_point(aes(size = Observed)) +
  coord_flip() +
  scale_x_reordered() +
  facet_grid(class~., scales = "free_y") +
  theme_bw() +
  xlab(xlabel) +
  guides(size = guide_legend(title = "# genes")) +
  scale_size_continuous(breaks = c(20,100,200))
}
```


# Figure 5A: Anatomy ontology of ELT-2 bound and differentially expressed genes
```{r fig.width=5, fig.height=4}
bound_tissue_df <- my_tea_analysis(input_df = fig4df, tea_dict = tissue_df)
bound_tissue_plot <- my_ontology_plot(bound_tissue_df, "Tissue Ontology")
bound_tissue_plot
```
save the tissue ontology plot

```{r}
if (do_plot == TRUE){
myggsave(plot = bound_tissue_plot, 
         name = "Figure5_ELT2_bound-DE_tissue_ontology",
         height = 4,
         width = 5,
         plotdir = plotdir)
}
```

# Determine the genes in each class with the corresponding tissue ontology term

```{r}
genes_in_terms <- function(tea_dict, bound_tea_df){
  tea_dict %>% 
  filter(wbid %in% (fig4df %>% filter(bound_class %in% bound_classes))$WBGeneID) %>% pivot_longer(-wbid) %>% filter(value == 1, name %in% bound_tea_df$Term) %>% 
  right_join(fig4df[c("WBGeneID", "SYMBOL")], by = c("wbid"= "WBGeneID")) %>% 
  dplyr::select(-value) %>%
  inner_join(bound_tea_df , by = c("name" = "Term")) %>%
  filter(class %in% bound_classes) %>%
  arrange(name)
  
}
```


```{r}
bound_tissue_genes <- genes_in_terms(tea_dict = tissue_df, bound_tea_df = bound_tissue_df)
head(bound_tissue_genes)
write.csv(bound_tissue_genes, file = "./02_output/Figre5_ELT2-Bound-DE_Tissue-Ontology_results.csv")
```

```{r}
bound_go_genes <- genes_in_terms(tea_dict = go_df, bound_tea_df = bound_go_df)
head(bound_go_genes)
write.csv(bound_go_genes, file = "./02_output/Figre5_ELT2-Bound-DE_Gene-Ontology_results.csv")
```

```{r}
bound_phenotype_genes <- genes_in_terms(tea_dict = phenotype_df, bound_tea_df = bound_phenotype_df)
head(bound_phenotype_genes)
write.csv(bound_phenotype_genes, file = "./02_output/Figre5_ELT2-Bound-DE_Phenotype-Ontology_results.csv")
```

# Phenotype ontology of ELT-2 bound and differentially expressed genes

```{r fig.width=5, fig.height=4}
bound_phenotype_df <- my_tea_analysis(input_df = fig4df, tea_dict = phenotype_df)
bound_phenotype_plot<- my_ontology_plot(bound_phenotype_df, "Phenotype Ontology")
bound_phenotype_plot
```
save the phenotype ontology plot

```{r}
if (do_plot == TRUE){
myggsave(plot = bound_phenotype_plot, 
         name = "Figure5_ELT2_bound-DE_phenotype_ontology",
         height = 4,
         width = 5,
         plotdir = plotdir)
}
```

# Gene ontology of ELT-2 bound and differentially expressed genes

```{r fig.width=8, fig.height=4}
bound_go_df <- my_tea_analysis(input_df = fig4df, tea_dict = go_df)
bound_go_plot <- my_ontology_plot(bound_go_df, "Gene Ontology")
bound_go_plot
```
save the phenotype ontology plot

```{r}
if (do_plot == TRUE){
myggsave(plot = bound_go_plot, 
         name = "Figure5_ELT2_bound-DE_gene_ontology",
         height = 4,
         width = 8,
         plotdir = plotdir)
}
```



# Fig 5A Enrichment of binding in each set

Use hypergeometric to determine if there is more ELT-2 binding in each set than expected by chance

```{r}
hyper_df <- fig4df %>% group_by(dineen_set) %>% summarise(set_total = n()) %>% inner_join(
  fig4df %>% filter(elt2_detected_in_L1 =="Direct") %>% group_by(dineen_set) %>% summarise(direct_total = n())) %>% inner_join(
  fig4df %>% filter(elt2_detected_in_L1 =="Indirect") %>% group_by(dineen_set) %>% summarise(indirect_total = n())) 

k <- hyper_df$set_total # sample size, the total number of genes in a single set

x <-  hyper_df$direct_total # the number of successes in the sample size, the number of bound genes within one set
m <- sum(hyper_df$direct_total) # population successes, number of bound genes in the  dataset 
n <- sum(hyper_df$indirect_total) # population non-successes, number of not bound genes
m
n
dhyper(x = x, k = k, m = m, n = n)
k*m/(m+n)
hyper_df_withinset <- hyper_df %>% rowwise() %>% mutate(dhyper = dhyper(x = direct_total, m = m, n = n, k = set_total), expected = set_total*m/(m+n)) 
# hyper_df_withinset %>% View()
```


```{r fig.width=4, fig.height=3}
hyper_df_long<- hyper_df_withinset%>% pivot_longer(cols = c("expected", "direct_total")) 
hyper_df_long$name <- factor(hyper_df_long$name, levels = c("expected", "direct_total"), labels = c("Expected", "Observed"))
hyper_df_long %>%
  ggplot(aes(x = dineen_set, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.75)+
  scale_color_manual(values = c("Expected" = "grey", "Observed" = "black"),
                     aesthetics = c("color", "fill")) +
  theme_classic() +
  ggtitle("Genes bound by ELT-2") +
  ylab("# genes in each set") +
  xlab("GATA Response Gene Sets") +
  labs(fill = "ELT-2 Binding")
```


```{r}
elt2_peaks <- readRDS(file = "../Figure_4_L1_Regulation/01_input/annotatedPeaks.rds")

# m, bound genes across the whole genome
m <- length(unique((as.data.frame(mcols(elt2_peaks)) %>% filter(L1_IDR == 1))$feature))
m
# n, genes not bound across the whole genome
n <- 20470 - m
n

hyper_df_genome <- hyper_df %>% rowwise() %>% mutate(dhyper = dhyper(x = direct_total, m = m, n = n, k = set_total), expected = set_total*m/(m+n)) 
hyper_df_genome %>% View()
```

```{r fig.width=4, fig.height=3}
hyper_df_genome_long<- hyper_df_genome%>% pivot_longer(cols = c("expected", "direct_total")) 
hyper_df_genome_long$name <- factor(hyper_df_genome_long$name, levels = c("expected", "direct_total"), labels = c("Expected", "Observed"))
hyper_df_genome_long %>%
  ggplot(aes(x = dineen_set, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.75)+
  scale_color_manual(values = c("Expected" = "grey", "Observed" = "black"),
                     aesthetics = c("color", "fill")) +
  theme_classic() +
  # ggtitle("Genes bound by ELT-2") +
  ylab("# genes in each set") +
  xlab("GATA Response Gene Sets") +
  labs(fill = "ELT-2 Binding")
```
# Figure S3 gene ontology analysis of ELT-2 occupancy clusters
Import data
```{r}
elt2_GRange <- readRDS(file = "../../ELT2_binding/annotatedPeaks.rds")
elt2_peaks <- as.data.frame(elt2_GRange)

elt2_peaks <- elt2_peaks %>% dplyr::rename(cluster.description = k4labels, WBGeneID = feature)
elt2_cluster_names <- c("Embryo_Specific",
                        "Larval",
                        "Increasing",
                        "L3_High",
                        "Not_Changing")

elt2_peaks$cluster.description <-
  factor(
    elt2_peaks$cluster.description,
    levels = c(
      "LE-specific",
      "Post-embryonic",
      "Increasing",
      "L3-high",
      "Not-changing or not IDR-passing"
    ),
    labels = elt2_cluster_names
  )
```


```{r}
tea_dicts <- c("tissue_df", "phenotype_df", "go_df")
elt2_tea_df <- data.frame()
for (i in elt2_cluster_names){
  for (j in tea_dicts){
  tea_set <- tea$enrichment_analysis(
    (elt2_peaks %>% filter(cluster.description == i))$WBGeneID, 
    tissue_df = eval(as.name(j)) %>% filter(wbid %in% elt2_peaks$WBGeneID)
  )
  # print(tea_set)
  if(nrow(tea_set) == 0){
    next
  } else {
  elt2_tea_df <- bind_rows(elt2_tea_df, data.frame(tea_set, cluster = i, analysis = j))
  }
  }
}
```

```{r fig.width=7, fig.height=6}
elt2_tea_GO <- elt2_tea_df %>%
  filter(Q.value < 0.05,  Observed > 5, analysis == "go_df") %>% group_by(cluster) %>% slice_max(Enrichment.Fold.Change, n = 6) %>%
  ggplot(aes(x = reorder_within(Term, -log10(Q.value), cluster), y = -log10(Q.value))) +
  geom_point(aes(size = Observed)) +
  coord_flip() +
  scale_x_reordered() +
  facet_grid(cluster~., scales = "free_y") +
  theme_bw() +
  ggtitle("ELT-2 Occupancy Clusters\nGO Terms")
elt2_tea_GO
if (do_plot == TRUE){
myggsave(plot = elt2_tea_GO, 
         name = "FigureS3_ELT2_OccupancyCluster_GO",
         height = 6,
         width = 7,
         plotdir = plotdir)
}

```
```{r fig.width=7, fig.height=6}
elt2_tea_tissue <- elt2_tea_df %>%
  filter(Q.value < 0.05,  Observed > 5, analysis == "tissue_df") %>% group_by(cluster) %>% slice_max(Observed, n = 6) %>%
  ggplot(aes(x = reorder_within(Term, -log10(Q.value), cluster), y = -log10(Q.value))) +
  geom_point(aes(size = Observed)) +
  coord_flip() +
  scale_x_reordered() +
  facet_grid(cluster~., scales = "free_y") +
  theme_bw() +
  ggtitle("ELT-2 Occupancy Clusters Tissue Terms")
elt2_tea_tissue
if (do_plot == TRUE){
myggsave(plot = elt2_tea_tissue, 
         name = "FigureS3_ELT2_OccupancyCluster_Tissue",
         height = 6,
         width = 7,
         plotdir = plotdir)
}
```
```{r fig.width=7, fig.height=6}
elt2_tea_phenotype <- elt2_tea_df %>%
  filter(Q.value < 0.05,  Observed > 5, analysis == "phenotype_df") %>% group_by(cluster) %>% slice_max(Observed, n = 6) %>%
  ggplot(aes(x = reorder_within(Term, -log10(Q.value), cluster), y = -log10(Q.value))) +
  geom_point(aes(size = Observed)) +
  coord_flip() +
  scale_x_reordered() +
  facet_grid(cluster~., scales = "free_y") +
  theme_bw() +
  ggtitle("ELT-2 Occupancy Clusters\nPhenotype Terms")
elt2_tea_phenotype
if (do_plot == TRUE){
myggsave(plot = elt2_tea_phenotype, 
         name = "FigureS3_ELT2_OccupancyCluster_Phenotype",
         height = 6,
         width = 7,
         plotdir = plotdir)
}
```


```{r}
wTF3 <- read.delim(file = "../Figure_4_L1_Regulation/01_input/TF3-0_namesonly.txt", ) %>% dplyr::select(Sequence.name:DBD)
wTF3

elt2_peaks %>% inner_join(wTF3, by = "WBGeneID") %>% View()
  group_by(cluster.description) %>% summarise(n = n())
```

# Tissue enrichment analysis of ELT-2 peaks by stage

```{r}
IDR_col <- c("LE_IDR", "L1_IDR", "L3_IDR")
chip_tea_df <- data.frame()
for (i in IDR_col){
  tea_set <- tea$enrichment_analysis(
    unique((elt2_peaks %>% filter(!!as.name(i) == 1))$WBGeneID), 
    tissue_df = tissue_df # %>% filter(wbid %in% elt2_peaks$WBGeneID)
  )
  if(nrow(tea_set) == 0){
    next
  } else {
  chip_tea_df <- bind_rows(chip_tea_df, data.frame(tea_set, cluster = i))
  }
}
```

```{r}
chip_tea_df %>%
  filter(Q.value < 0.05,  Observed > 10) %>% group_by(cluster) %>% slice_max(Observed, n = 6) %>%
  ggplot(aes(x = reorder_within(Term, -log10(Q.value), cluster), y = -log10(Q.value))) +
  geom_point(aes(size = Observed)) +
  coord_flip() +
  scale_x_reordered() +
  facet_grid(cluster~., scales = "free_y") +
  theme_bw() +
  ggtitle("ELT-2 ChIP-seq Clusters Terms")
```


# Fig 5B Measure association between ELT-2/ELT-7 response clusters to intestine development clusters
 
```{r}
fig3df <- read_csv(file = "../Figure_3_Intestine_Expression_Patterns/02_output/Fig3_Intestine_Development_Cluster_Assignments.csv")

e2e7clust_intdevclust <- fig3df %>% right_join(fig4df %>% filter(!is.na(bound_class)), by = "WBGeneID") %>% dplyr::select(WBGeneID, intestine_dev_cluster, bound_class) 
# make "Not_Intestine" category
e2e7clust_intdevclust$intestine_dev_cluster <- factor(e2e7clust_intdevclust$intestine_dev_cluster, levels = c("Embryonic", "L1", "Post-embryonic", "Adult", "Not_Intestine"))
e2e7clust_intdevclust$intestine_dev_cluster[is.na(e2e7clust_intdevclust$intestine_dev_cluster)] <- "Not_Intestine"

table(e2e7clust_intdevclust$bound_class, e2e7clust_intdevclust$intestine_dev_cluster)
```

```{r}
intdevmosaic <- table(e2e7clust_intdevclust$bound_class, e2e7clust_intdevclust$intestine_dev_cluster)

dineen_dev_pearson_residuals <-
  as.data.frame(chisq.test(intdevmosaic, simulate.p.value = TRUE)$stdres)
dineen_dev_pearson_residuals <-
  cbind(dineen_dev_pearson_residuals,
        as.data.frame(chisq.test(intdevmosaic, simulate.p.value = TRUE)$observed)$Freq)
colnames(dineen_dev_pearson_residuals) <-
  c("Dineen_Class", "ELT2_cluster", "Pearson_Residual", "Observed")
# set factor levels
dineen_dev_pearson_residuals$Dineen_Class <-
  factor(
    dineen_dev_pearson_residuals$Dineen_Class,
    levels = c("ClassD", "ClassC", "ClassB", "ClassA")
  )
# set factor levels
dineen_dev_pearson_residuals$ELT2_cluster <-
  factor(
    dineen_dev_pearson_residuals$ELT2_cluster,
    levels = c(
      "Embryonic",
      "L1",
      "Post-embryonic",
      "Adult",
      "Not_Intestine"
    )
  )
# add q-value
intdevmosaic.chisq <- chisq.test(intdevmosaic, simulate.p.value = TRUE)
q <- p.adjust(
  2*pnorm(
    abs(intdevmosaic.chisq$stdres), 
    lower.tail = FALSE), 
  method = "BH")
intdevmosaic.q <- matrix(q, ncol = 5)
dimnames(intdevmosaic.q) <- dimnames(intdevmosaic)
intdevmosaic.q<- as.table(intdevmosaic.q)
dineen_dev_pearson_residuals <- cbind(
  dineen_dev_pearson_residuals, 
  p.value = as.data.frame(2*pnorm(abs(intdevmosaic.chisq$stdres), lower.tail = FALSE))$Freq,
  p.adjust = as.data.frame(intdevmosaic.q)$Freq
  )
# write_csv(dineen_dev_pearson_residuals, file = "./02_output/TableS6_elt2elt7_response_intestine_development.csv")
```


```{r fig.widt = 3, fig.height=4}
# draw the plot
# Add pass vs fail for pvalue

dineen_bound_ELT2_mosiac <- ggplot(dineen_dev_pearson_residuals,
       aes(x = ELT2_cluster, y = Dineen_Class)) +
  geom_point(aes(size = Observed, fill = Pearson_Residual, colour = p.adjust < 0.05), shape = 21, stroke = 1) + 
  scale_fill_gradient2(
    high = "red",
    low = "blue",
    mid = "white",
    midpoint = 0,
  ) +
  scale_size_continuous(range = c(1,5), 
                        breaks = c(1,10,max(dineen_dev_pearson_residuals$Observed))) +
  scale_color_manual(values = c("light grey", "black")) +  
theme_bw() +
  theme(axis.text.x = element_text(angle = -45, hjust = 0)) +
  # theme(legend.key.width = unit(0.125,"in"), legend.key.height = unit(0.125, "in"), legend.key.size = unit(0.01, "in"), axis.text.x = element_text(angle = -45, hjust = 0), legend.background = element_rect(fill="lightblue", size=0.5, linetype="solid")) +
  theme(legend.key.height = unit(0.125, "in"), legend.margin = margin(0.1,0.1,0.1,0.1)) +
  # guides(fill = )
  guides(fill = guide_colorbar(title = "pearson residual",title.position = "top",label.position = "bottom", direction = "horizontal"),
         size = guide_legend(title = "# genes"),
         color = guide_legend(title = "q < 0.05")) +
  xlab("Intestine Development Cluster\n(from RNA-seq)") +
  ylab("ELT-2/ELT-7 Response Cluster\n(from RNA-seq)")

dineen_bound_ELT2_mosiac 
```


