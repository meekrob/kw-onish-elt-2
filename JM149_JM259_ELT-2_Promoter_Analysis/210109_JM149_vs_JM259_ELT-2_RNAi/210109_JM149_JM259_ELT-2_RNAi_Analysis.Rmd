---
title: "210109_JM149_JM259_ELT-2_RNAi_Analysis"
author: "IRM"
date: "210109"
output:
  pdf_document: default
  html_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Install libraries

```{r}
# install.packages("knitr")
# install.packages("readxl")
# install.packages("tidyverse")
# install.packages("ggpubr")
# install.packages("mratios")
```


Load libraries

```{r}
library(readxl)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(tidyverse)
library(mratios)
```


Load in data


```{r}
sheets <- c("JM149_Rep1_ELT-2",  "JM149_Rep2_ELT-2", "JM149_Rep3_ELT-2",  "JM259_Rep1_ELT-2", "JM259_Rep2_ELT-2",  "JM259_Rep3_ELT-2")


image_df <- data.frame()
for(sheet in sheets) {
 toappend <- read_excel("./JM149_JM259_ELT-2_RNAi_Analysis.xlsx", sheet = sheet)
 toappend <- toappend %>% mutate(experiment = sheet)
 toappend$worm <- as.character(toappend$worm)
 image_df <- bind_rows(image_df, toappend)
}

image_df %>% head()
```

```{r}
image_df$worm_strain <- factor(image_df$worm_strain, levels = c("JM149", "JM259"))

image_df$life_stage <- factor(image_df$life_stage, levels = c("L1", "L3", "adult"))


image_df$life_stage %>% unique()
```

```{r}
image_df <- image_df %>%
  mutate(ID = paste(experiment, life_stage, worm, sep = "_"))
```



Calculate the corrected total cell fluorescence (CTCF)

CTCF = Integrated Density â€“ (Area of selected cell X Mean fluorescence of background readings)

Calculate the mean background value for each image

```{r}
colnames(image_df)
```
```{r}
background_df<- image_df %>%
  group_by(worm_strain, worm, measurement_type, life_stage, experiment, ID) %>%
  summarize(Mean_Background = mean(mean)) %>% 
  filter(measurement_type == "background") %>%
  ungroup() %>%
  select(ID, Mean_Background)
background_df
```

Combine the mean of mean background values with the integrated density and intestine area. Calculate the corrected total cell flourescence.

```{r}
colnames(image_df)
image_df$measurement_type %>% unique()
```


```{r}
image_ctcf <- image_df %>%
  filter(measurement_type == "GFP") %>%
  select(ID, worm_strain, worm, area, life_stage, experiment, intDen) %>%
  inner_join(background_df, by = "ID") %>%
  mutate(CTCF = intDen - (area*Mean_Background) )
image_ctcf  

```

Plot the results
Boxplot
```{r}
ggplot(image_ctcf, aes(worm_strain, CTCF)) + 
  geom_boxplot() +
  geom_jitter(aes(fill = experiment, color = experiment)) +
  facet_grid(.~life_stage) +
  scale_y_log10() +
  labs(
    title = "elt-2 Promoter Fluorescence Intensity ELT-2 RNAi During Development",
    x = "Worm Strain",
    y = "Corrected Total Cell \nFluorescence (A.U.)"
  ) +
  stat_compare_means(comparisons = list(c("JM149", "JM259")), method = "t.test") +
  scale_x_discrete(labels = c("JM149", "JM259"))+
  theme_classic() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, size = 1),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size=18),
    plot.title = element_text(hjust = 0.5, size = 18)
    )
  
```




Plot with area taken into account

```{r}
ggplot(image_ctcf, aes(x = worm_strain, y = CTCF/area)) + 
  geom_boxplot() +
  geom_jitter(aes(fill = experiment, color = experiment)) +
  facet_grid(.~life_stage, scales = "free_y") +
  scale_y_log10() +
  labs(
    title = "elt-2 Promoter Fluorescence Intensity \nELT-2 RNAi Corrected for Area",
    x = "Worm Strain",
    y = "Corrected Total Cell \nFluorescence (A.U.)"
  ) +
  stat_compare_means(comparisons = list(c("JM149", "JM259")), method = "t.test") +
  scale_x_discrete(labels = c("JM149", "JM259"))+
  theme_classic()+
  theme(
    panel.border = element_rect(colour = "black", fill = NA, size = 0.5),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size=20),
    plot.title = element_text(hjust = 0.5, size = 20)
    )
```

save plot
```{r}
ggsave("210109_JM149_JM259_ELT-2_RNAi_Area_Included.pdf", width = 7.5, height = 5.5)
```


To see how much brighter JM149 is compared to JM259

```{r}
mean_ctcf <-
  image_ctcf %>%
  group_by(worm_strain, life_stage) %>%
  summarise(avgCTCF = mean(CTCF), sdCTCF = sd(CTCF))

mean_ctcf <-
  mean_ctcf %>% pivot_wider(names_from = worm_strain,
                            values_from = c(avgCTCF, sdCTCF))
mean_ctcf
```



bar graph for mean ELT-2 CTCF / mean L4440 CTCF with confidence intervals

```{r}
image_ctcf %>% filter(life_stage=='adult' & worm_strain == 'JM149') %>% select(CTCF) -> numerator
image_ctcf %>% filter(life_stage=='adult' & worm_strain == 'JM259') %>% select(CTCF) -> denominator
ttestratio(numerator[[1]], denominator[[1]]) -> adult_ttest_ratio
image_ctcf %>% filter(life_stage=='L3' & worm_strain == 'JM149') %>% select(CTCF) -> numerator
image_ctcf %>% filter(life_stage=='L3' & worm_strain == 'JM259') %>% select(CTCF) -> denominator
ttestratio(numerator[[1]], denominator[[1]]) -> L3_ttest_ratio
image_ctcf %>% filter(life_stage=='L1' & worm_strain == 'JM149') %>% select(CTCF) -> numerator
image_ctcf %>% filter(life_stage=='L1' & worm_strain == 'JM259') %>% select(CTCF) -> denominator
ttestratio(numerator[[1]], denominator[[1]]) -> L1_ttest_ratio
    
mean_ctcf$lower = c(L1_ttest_ratio$conf.int[1], L3_ttest_ratio$conf.int[1], adult_ttest_ratio$conf.int[1])
mean_ctcf$upper = c(L1_ttest_ratio$conf.int[2], L3_ttest_ratio$conf.int[2], adult_ttest_ratio$conf.int[2])

ggplot(mean_ctcf, aes(x = life_stage, y = `avgCTCF_JM149`/avgCTCF_JM259)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  labs(
    title = "elt-2 Promoter Relative Fluorescence\nIntensity ELT-2 RNAi") +
  theme_classic()+
  theme(
    panel.border = element_rect(colour = "black", fill = NA, size = 0.5),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size=20),
    plot.title = element_text(hjust = 0.5, size = 20)
    )
 
```

Save the plot

```{r}
ggsave("210109_JM149_JM259_ELT-2_RNAi_Relative_Promoter_Fluorescence.pdf", width = 6, height = 5)
```

Redo above plot with corrected by area
