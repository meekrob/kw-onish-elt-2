---
title: "210112_IM_JM259_AllReps_Analysis"
author: "IRM"
date: "210112"
output:
  pdf_document: default
  html_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Install libraries

```{r}
# install.packages("knitr")
# install.packages("readxl")
# install.packages("tidyverse")
# install.packages("ggpubr")
# install.packages("mratios")
```


Load libraries

```{r}
library(readxl)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(tidyverse)
library(mratios)
```


Load in data


```{r}
sheets <- c("Rep1_ELT-2_RNAi",  "Rep1_L4440_RNAi", "Rep2_ELT-2_RNAi",  "Rep2_L4440_RNAi", "Rep3_ELT-2_RNAi",  "Rep3_L4440_RNAi")


image_df <- data.frame()
for(sheet in sheets) {
 toappend <- read_excel("./JM259_Reps123_elt-2_Promoter_ImageJ_Analysis.xlsx", sheet = sheet)
 toappend <- toappend %>% mutate(experiment = sheet)
 toappend$worm <- as.character(toappend$worm)
 image_df <- bind_rows(image_df, toappend)
}

image_df %>% head()
```

```{r}
image_df$treatment <- factor(image_df$treatment, levels = c("L4440", "ELT-2"))

image_df$life_stage <- factor(image_df$life_stage, levels = c("L1", "L3", "adult"))


image_df$life_stage %>% unique()
```

```{r}
image_df <- image_df %>%
  mutate(ID = paste(experiment, life_stage, worm, sep = "_"))
```



Calculate the corrected total cell fluorescence (CTCF)

CTCF = Integrated Density â€“ (Area of selected cell X Mean fluorescence of background readings)

Calculate the mean background value for each image

```{r}
colnames(image_df)
```
```{r}
background_df<- image_df %>%
  group_by(treatment, worm, measurement_type, life_stage, experiment, ID) %>%
  summarize(Mean_Background = mean(mean)) %>% 
  filter(measurement_type == "background") %>%
  ungroup() %>%
  select(ID, Mean_Background)
background_df
```

Combine the mean of mean background values with the integrated density and intestine area. Calculate the corrected total cell flourescence.

```{r}
colnames(image_df)
image_df$measurement_type %>% unique()
```


```{r}
image_ctcf <- image_df %>%
  filter(measurement_type == "GFP") %>%
  select(ID, treatment, worm, area, life_stage, experiment, intDen) %>%
  inner_join(background_df, by = "ID") %>%
  mutate(CTCF = intDen - (area*Mean_Background) )
image_ctcf  

```

Plot the results
Boxplot
```{r}
ggplot(image_ctcf, aes(treatment, CTCF)) + 
  geom_boxplot() +
  geom_jitter(aes(fill = experiment, color = experiment)) +
  facet_grid(.~life_stage) +
  scale_y_log10() +
  labs(
    title = "elt-2 Promoter Fluorescence Intensity During Development",
    x = "RNAi Treatment",
    y = "Corrected Total Cell \nFluorescence (A.U.)"
  ) +
  stat_compare_means(comparisons = list(c("L4440", "ELT-2")), method = "t.test") +
  scale_x_discrete(labels = c("L4440", "ELT-2"))+
  theme_classic() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, size = 1),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size=18),
    plot.title = element_text(hjust = 0.5, size = 18)
    )
  
```




Plot with area taken into account

```{r}
ggplot(image_ctcf, aes(x = treatment, y = CTCF/area)) + 
  geom_boxplot() +
  geom_jitter(aes(fill = experiment, color = experiment)) +
  facet_grid(.~life_stage) +
  scale_y_log10(limits = c(0.1,10)) +
  labs(
    title = "elt-2 Promoter Fluorescence Intensity During\nDevelopment Corrected for Area",
    x = "RNAi Treatment",
    y = "Corrected Total Cell \nFluorescence (A.U.)"
  ) +
  stat_compare_means(comparisons = list(c("L4440", "ELT-2")), method = "t.test") +
  scale_x_discrete(labels = c("L4440", "ELT-2"))+
  theme_classic()+
  theme(
    panel.border = element_rect(colour = "black", fill = NA, size = 0.5),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size=20),
    plot.title = element_text(hjust = 0.5, size = 20)
    )
```

save plot
```{r}
ggsave("210112_JM259_AllReps_ELT-2_RNAi_Development_Series_Area_Included.pdf", width = 7.5, height = 5.5)
```


just L4440 plot
```{r}
ggplot(image_ctcf %>% filter(treatment == "L4440"), 
       aes(x = life_stage, y = CTCF/area)) + 
  geom_boxplot() +
  geom_jitter(aes(fill = experiment, color = experiment)) +
  scale_y_log10() +
  labs(
    title = "elt-2 Promoter Fluorescence Intensity for L4440 RNAi\nDuring Development Corrected for Area",
    x = "Life Stage",
    y = "Corrected Total Cell \nFluorescence (A.U.)"
  ) +
  # stat_compare_means(comparisons = list(c("L4440", "ELT-2")), method = "t.test") +
  # scale_x_discrete(labels = c("L4440", "ELT-2"))+
  theme_classic() 
```



To see how much brighter ELT-2 is compared to L4440

```{r}
mean_ctcf <-
  image_ctcf %>%
  group_by(treatment, life_stage) %>%
  summarise(avgCTCF = mean(CTCF), sdCTCF = sd(CTCF))

mean_ctcf <-
  mean_ctcf %>% pivot_wider(names_from = treatment,
                            values_from = c(avgCTCF, sdCTCF))
mean_ctcf
```



bar graph for mean ELT-2 CTCF / mean L4440 CTCF with confidence intervals

```{r}
image_ctcf %>% filter(life_stage=='adult' & treatment == 'ELT-2') %>% select(CTCF) -> numerator
image_ctcf %>% filter(life_stage=='adult' & treatment == 'L4440') %>% select(CTCF) -> denominator
ttestratio(numerator[[1]], denominator[[1]]) -> adult_ttest_ratio
image_ctcf %>% filter(life_stage=='L3' & treatment == 'ELT-2') %>% select(CTCF) -> numerator
image_ctcf %>% filter(life_stage=='L3' & treatment == 'L4440') %>% select(CTCF) -> denominator
ttestratio(numerator[[1]], denominator[[1]]) -> L3_ttest_ratio
image_ctcf %>% filter(life_stage=='L1' & treatment == 'ELT-2') %>% select(CTCF) -> numerator
image_ctcf %>% filter(life_stage=='L1' & treatment == 'L4440') %>% select(CTCF) -> denominator
ttestratio(numerator[[1]], denominator[[1]]) -> L1_ttest_ratio
    
mean_ctcf$lower = c(L1_ttest_ratio$conf.int[1], L3_ttest_ratio$conf.int[1], adult_ttest_ratio$conf.int[1])
mean_ctcf$upper = c(L1_ttest_ratio$conf.int[2], L3_ttest_ratio$conf.int[2], adult_ttest_ratio$conf.int[2])

ggplot(mean_ctcf, aes(x = life_stage, y = `avgCTCF_ELT-2`/avgCTCF_L4440)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  labs(
    title = "elt-2 Promoter Relative Fluorescence\nIntensity During Development") +
  theme_classic()+
  theme(
    panel.border = element_rect(colour = "black", fill = NA, size = 0.5),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size=20),
    plot.title = element_text(hjust = 0.5, size = 20)
    )
 
```

Save the plot

```{r}
ggsave("210112_JM259_AllReps_Relative_Promoter_Fluorescence.pdf", width = 6, height = 5)
```

Redo above plot with corrected by area
